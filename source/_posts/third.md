---
title: mysql多对多的数据的一种存储方案
date: 2018-11-16 19:47:15
categories: 
    - "数据库"
    - "mysql"
toc_number: true
tags:
	- java
	- 二进制
	- 位运算
---
## 前言
之所以做这个算法，缘由一个数据库设计的需求：mysql数据库2张多对多关系表，在不使用中间表的情况下，实现关联。
接到需求的时候，多少有点惊讶，mysql还有这种特性？实际了解之后发现，和我想的不同，而且实用性不大，但不乏是一种解决问题的思路。
<!--more-->
---
## 实现条件
  - 数据库支持位运算
  - 2张表数据量不大
---
## 实现原理
  - 2的N次方转换成二进制：2^0 = 1 -> 0001、2^1 = 2 -> 0010、2^2 = 4 -> 0100... 在二进制运算中，这些数值在**不相同的情况下**相加不会出现进位情况 0001 + 0010 = 0011、0100 + 0010 = 0110 因为数值位1是错位的。
  - 位运算符&：按位与，其功能是参与运算的两数各对应的二进位相与，只要对应的两个二进位都为1时，结果位就为1。0011 & 0001 = 0001。
  - 当然的，相同数值位与得到值的即本身：0001 & 0001 = 0001。
  - 综合上面的条件，两个**值不同的**2的N次幂相加的和，按位与(&)任意加数会得到加数本身。通过**它们的和**能判断出是否包含某个加数或者求得所有加数。
---
### java实现
代码:</br>

```java
int d = 31; //d可以是任意正整数，因为二级制位不是0就是1，2的N次方数值本身还有求和的数值正好满足所有可能
for (int r = 1; d >= r; r = r << 1) {
	if ((d & r) == r) {
		System.out.println(r);
	}
}
```

结果：  
1  
2  
4  
8  
16  

1 + 2 + 4 + 8 + 16 = 31

---
### 数据库实现
  1. a表包含字段a_id,数值由代码维护，保证是2的N次方且唯一
  2. b表包含字段a_ids,对应多个a表记录_id字段的和
  3. 查询b表关联的a表记录:select a.* from a,b where __b.a_ids & a.a_id = a.a_id__ and b.b_id = ?
  
## 优缺点
### 优点
  1. 不使用中间表，节省了数据库空间
  2. 少了张表的关联也提升了查询效率
  
### 缺点
  1. 缺少中间表，也就不能做更多配置,比如可以在中间表中配置过滤、格式化规则
  2. 2的N次幂数值增长太快，大大限制了表中数据量
  3. 被关联表的修改、删除会影响关联表的数据，维护成本增加
